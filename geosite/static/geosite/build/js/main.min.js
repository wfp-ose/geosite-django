var geosite={directives:{},filters:{},vecmath:{},tilemath:{}};geosite.assert_float=function(e,t){return void 0===e||""===e?t:angular.isNumber(e)?e:parseFloat(e)},geosite.assert_array_length=function(e,t,a){return void 0===e||""===e?a:angular.isString(e)?(e=e.split(","),e.length==t?e:a):angular.isArray(e)?e.length==t?e:a:void 0},geosite.intend=function(e,t,a){a.$emit(e,t)},geosite.init_intents=function(e,t){e.on("click",".geosite-intent",function(e){e.preventDefault();var a=$(this);if(a.hasClass("geosite-toggle"))a.hasClass("geosite-off")?(a.removeClass("geosite-off"),geosite.api.intend(a.data("intent-names")[0],a.data("intent-data"),t)):(a.addClass("geosite-off"),geosite.api.intend(a.data("intent-names")[1],a.data("intent-data"),t));else if(a.hasClass("geosite-radio")){var i=a.parents(".geosite-radio-group:first").find(".geosite-radio").not(a);a.hasClass("geosite-on")||(a.addClass("geosite-on"),a.data("intent-class-on")&&(a.addClass(a.data("intent-class-on")),i.removeClass(a.data("intent-class-on"))),i.removeClass("geosite-on"),a.data("intent-class-off")&&(a.removeClass(a.data("intent-class-off")),i.addClass(a.data("intent-class-off"))),geosite.api.intend(a.data("intent-name"),a.data("intent-data"),t))}else geosite.api.intend(a.data("intent-name"),a.data("intent-data"),t)})},geosite.controllers={},geosite.controllers.controller_base=function(e,t){this.intend=geosite.intend,geosite.init_intents($(t),e),e.toggleModal=function(e){$(e).modal("toggle")}},geosite.init_controller_base=function(e){e.controller("GeositeControllerBase",geosite.controllers.controller_base)},geosite.init_controller=function(e,t,a){var i=e.data("controllerName");e.data("controllerType");t.controller(i,a||geosite.controllers.controller_base)},geosite.init_controllers=function(e,t,a){for(var i=0;i<a.length;i++){var o=a[i];$(o.selector,e).each(function(){try{geosite.init_controller($(this),t,o.controller)}catch(e){console.log('Could not load Geosite Controller "'+o.selector+'"',e)}})}},geosite.vecmath={},geosite.vecmath.distance=function(e,t){var a=L.Projection.SphericalMercator;if(void 0!=t.toString&&t.toString().startsWith("LatLng"))return a.project(e).distanceTo(a.project(t));var i=void 0;return $.each(t._layers,function(t,o){var r=o._latlngs,n=0;for(void 0==i&&(i=L.LineUtil.pointToSegmentDistance(a.project(e),a.project(r[n]),a.project(r[n+1])),n++);n<r.length-1;n++){var s=L.LineUtil.pointToSegmentDistance(a.project(e),a.project(r[n]),a.project(r[n+1]));i>s&&(i=s)}}),i},geosite.vecmath.closestLocation=function(e,t){if(void 0!=t.toString&&t.toString().startsWith("LatLng"))return t;var a=L.Projection.SphericalMercator,i=void 0,o=void 0;return $.each(t._layers,function(t,r){var n=r._latlngs,s=0;for(void 0==i&&(i=L.LineUtil.pointToSegmentDistance(a.project(e),a.project(n[s]),a.project(n[s+1])),o=L.LineUtil.closestPointOnSegment(a.project(e),a.project(n[s]),a.project(n[s+1])),s++);s<n.length-1;s++){var l=L.LineUtil.pointToSegmentDistance(a.project(e),a.project(n[s]),a.project(n[s+1]));i>l&&(i=l,o=L.LineUtil.closestPointOnSegment(a.project(e),a.project(n[s]),a.project(n[s+1])))}}),a.unproject(o)},geosite.vecmath.getClosestFeatureAndLocation=function(e,t){var a=void 0,i=0,o=void 0;if(void 0!=e&&e.length>0){a=e[0],i=geosite.vecmath.distance(t,e[0].geometry),o=geosite.vecmath.closestLocation(t,e[0].geometry);for(var r=1;r<e.length;r++){var n=e[r];geosite.vecmath.distance(t,n.geometry)<i&&(a=n,i=geosite.vecmath.distance(t,n.geometry),o=geosite.vecmath.closestLocation(t,n.geometry))}}return{feature:a,location:o}},geosite.init_state=function(e,t){var a=$.extend({},e),i=getHashValueAsFloat(["latitude","lat","y"])||e.lat||0,o=getHashValueAsFloat(["longitude","lon","long","lng","x"])||e.lon||0,r=getHashValueAsInteger(["zoom","z"])||e.z||3,n={lat:i,lon:o,z:r};return a.view=void 0!=a.view?$.extend(a.view,n):n,void 0!=a.filters&&$.each(a.filters,function(e,i){$.each(i,function(i,o){var r=t.filters[e][i].toLowerCase(),n=getHashValue(e+":"+i,r);void 0!=n&&""!=n&&(a.filters[e][i]=n)})}),void 0!=a.styles,a},geosite.ui_init_slider_label=function(e,t,a,i){if("ordinal"==t){var o=e.data("label-template").replace(new RegExp("{{(\\s*)value(\\s*)}}","gi"),i);e.data("label").html(o)}else if("continuous"==t)if("boolean"==$.type(a)&&a||"true"==a.toLowerCase()){var o=e.data("label-template").replace(new RegExp("{{(\\s*)value(s?).0(\\s*)}}","gi"),i[0]).replace(new RegExp("{{(\\s*)value(s?).1(\\s*)}}","gi"),i[1]);e.data("label").html(o)}else if("min"==a||"max"==a){var o=e.data("label-template").replace(new RegExp("{{(\\s*)value(\\s*)}}","gi"),i);e.data("label").html(o)}},geosite.ui_init_slider_slider=function(e,t,a,i,o,r,n,s){"ordinal"==a?t.slider({range:"boolean"==$.type(i)&&i||"true"==i.toLowerCase()?!0:i,value:o,min:0,max:n,step:1,slide:function(a,i){geosite.ui_update_slider_label.apply(this,[a,i]);var o=t.data("output"),r=t.data("options")[i.value],n={};n[o]=r,geosite.api.intend("filterChanged",{layer:"popatrisk",filter:n},e)}}):"continuous"==a&&("boolean"==$.type(i)&&i||"true"==i.toLowerCase()?t.slider({range:!0,values:o,min:r,max:n,step:s,slide:function(a,i){geosite.ui_update_slider_label.apply(this,[a,i]);var o=t.data("output"),r=i.values,n={};n[o]=r,geosite.api.intend("filterChanged",{layer:"popatrisk",filter:n},e)}}):("min"==i||"max"==i)&&t.slider({range:i,value:o,min:r,max:n,step:s,slide:function(a,i){geosite.ui_update_slider_label.apply(this,[a,i]);var o=t.data("output"),r=i.value/100,n={};n[o]=r,geosite.api.intend("filterChanged",{layer:"popatrisk",filter:n},e)}}))},geosite.ui_update_slider_label=function(e,t){var a=$(this),i=a.data("type"),o=a.data("range");if("ordinal"==i){var r=a.data("options")[t.value],n=a.data("label-template").replace(new RegExp("{{(\\s*)value(\\s*)}}","gi"),r);a.data("label").html(n)}else if("continuous"==i)if("boolean"==$.type(o)&&o||"true"==o.toLowerCase()){var n=a.data("label-template").replace(new RegExp("{{(\\s*)value(s?).0(\\s*)}}","gi"),t.values[0]).replace(new RegExp("{{(\\s*)value(s?).1(\\s*)}}","gi"),t.values[1]);a.data("label").html(n)}else if("min"==o||"max"==o){var n=a.data("label-template").replace(new RegExp("{{(\\s*)value(\\s*)}}","gi"),t.value/100);a.data("label").html(n)}};var getHashValue=function(e,t){var a=void 0;e="string"==typeof e?[e.toLowerCase()]:$.map(e,function(e,t){return e.toLowerCase()});for(var i=location.hash.toLowerCase(),o=0;o<e.length;o++){var r=e[o],n=i.match(new RegExp(r+"=([^&]*)"));if(n&&(a=n[1],void 0!=a&&null!=a&&""!=a))break}if(void 0!=t)if("integer"==t)a=void 0!=a&&null!=a&&""!=a?parseInt(a,10):void 0;else if("integerarray"==t){if(void 0!=a){for(var s=a.split(","),l=[],o=0;o<s.length;o++){var u=s[o];l.push(void 0!=u&&null!=u&&""!=u?parseInt(u,10):void 0)}a=l}}else if("float"==t)a=void 0!=a&&null!=a&&""!=a?parseFloat(a):void 0;else if("floatarray"==t&&void 0!=a){for(var s=a.split(","),l=[],o=0;o<s.length;o++){var u=s[o];l.push(void 0!=u&&null!=u&&""!=u?parseFloat(u):void 0)}a=l}return a},hasHashValue=function(e){var t=getHashValue(e);return void 0!=t&&null!=t&&""!=t},getHashValueAsInteger=function(e){return getHashValue(e,"integer")},getHashValueAsIntegerArray=function(e){return getHashValue(e,"integerarray")},getHashValueAsFloat=function(e){return getHashValue(e,"float")},sortLayers=function(e,t){var a=$.isArray(e)?e:$.map(e,function(e){return e});return a=a.sort(function(e,t){return e.options.renderOrder-t.options.renderOrder}),t===!0&&a.reverse(),a},updateRenderOrder=function(e){for(var t=0;t<e.length;t++)e[t].bringToFront()},layersAsArray=function(e){return $.map(e,function(e,t){return{id:t,layer:e}})},extract=function(e,t){var a=void 0;if(0==e.length)a=t;else if(void 0!=t){var i=e.slice(1),o=Array.isArray(t)?t[e[0]]:t[""+e[0]];a=extract(i,o)}return a};geosite.codec={},geosite.codec.parseFeatures=function(e,t){var a=[];return $(e).find("gml\\:featuremember").each(function(){var e=$(this).children(),i=e.prop("tagName").toLowerCase(),o=geosite.codec.parseAttributes(e,t[i]),r=e.find("geonode\\:shape"),n=void 0;if(r.find("gml\\:point").length>0){var s=r.find("gml\\:point").find("gml\\:coordinates").text().split(",");n=new L.LatLng(parseFloat(s[1]),parseFloat(s[0]))}else if(r.find("gml\\:multilinestring").length>0){var s=r.find("gml\\:multilinestring").find("gml\\:linestringmember").find("gml\\:linestring").find("gml\\:coordinates").text().split(" ");s=$.map(s,function(e,t){var a=e.split(",");return[[parseFloat(a[0]),parseFloat(a[1])]]});var l=[{type:"LineString",coordinates:s}];n=new L.GeoJSON(l,{})}var u={featuretype:i,attributes:o,geometry:n};a.push(u)}),a},geosite.codec.parseAttributes=function(e,t){for(var a={},i=0;i<t.length;i++){var o=t[i],r=o.output||o.attribute;a[r]=void 0;var n=o.attribute||o.input,s=void 0!=n?[n]:o.inputs;if(void 0!=s)for(var l=0;l<s.length;l++){var n=s[l];if(e.find("geonode\\:"+n).length>0){a[r]=e.find("geonode\\:"+n).text();break}}}return a},geosite.popup={},geosite.popup.buildField=function(e,t,a){var i=e.output||e.attribute,o=void 0,r=!1;if(void 0!=e.when&&"defined"==e.when.toLowerCase()?void 0!=a.attributes[i]&&(r=!0):r=!0,r)if("link"==e.type){var n=void 0!=e.value?e.value:"{{ feature.attributes."+i+" }}";o="<span><b>"+e.label+':</b> <a target="_blank" href="'+e.url+'">',o+=n,o+="</a></span>"}else{var n=void 0;if(void 0!=e.value)n=e.value;else{if("date"==e.type){var s=e.format||"medium";n="feature.attributes."+i+" | date:'"+s+"'"}else n="feature.attributes."+i;e.fallback&&(n="("+n+") || '"+e.fallback+"'"),n="{{ "+n+" }}"}o="<span><b>"+e.label+":</b> "+n+"</span>"}return o},geosite.popup.buildPopupTemplate=function(e,t,a){var i=e.panes,o="";angular.isDefined(e.title)&&(o+='<h5 style="word-wrap:break-word;text-align:center;">'+e.title+"</h5>");for(var r=[],n=0;n<i.length;n++){for(var s=i[n],l=[],u=0;u<s.fields.length;u++){var d=geosite.popup.buildField(s.fields[u],t,a);void 0!=d&&l.push(d)}var g=l.join("<br>");r.push(g)}if(i.length>1){var p=[],s=i[0];p.push('<li class="active"><a data-toggle="tab" href="#'+s.id+'">'+s.tab.label+"</a></li>");for(var n=1;n<i.length;n++)s=i[n],p.push('<li><a data-toggle="tab" href="#'+s.id+'">'+s.tab.label+"</a></li>");var c='<ul class="nav nav-tabs nav-justified">'+p.join("")+"</ul>",f=[];f.push('<div id="'+i[0].id+'" class="tab-pane fade in active">'+r[0]+"</div>");for(var n=1;n<i.length;n++)f.push('<div id="'+i[n].id+'" class="tab-pane fade">'+r[n]+"</div>");var v='<div class="tab-content">'+f.join("")+"</div>";o+=c+v}else o+=r[0];return o},geosite.popup.openPopup=function(e,t,a,i,o){var r=t,n=geosite.popup.buildPopupTemplate(r.popup,t,a),s={layer:t,feature:a},l=e(n)(s),u=new L.Popup({maxWidth:r.popup.maxWidth||400},void 0);u.setLatLng(new L.LatLng(i.lat,i.lon)),u.setContent(l),o.openPopup(u)},geosite.tilemath={D2R:Math.PI/180,R2D:180/Math.PI},geosite.tilemath.point_to_bbox=function(e,t,a,i){var o=geosite.tilemath.point_to_radius(a),r=e+o;void 0!=i&&i>=0&&(r=r.toFixed(i));var n=e-o;void 0!=i&&i>=0&&(n=n.toFixed(i));var s=t-o;void 0!=i&&i>=0&&(s=s.toFixed(i));var l=t+o;return void 0!=i&&i>=0&&(l=l.toFixed(i)),[n,s,r,l]},geosite.tilemath.point_to_radius=function(e){return(geosite.config.click_radius||4)/e},geosite.tilemath.tms_to_bbox=function(e,t,a){var i=geosite.tilemath.tile_to_lon(e+1,a),o=geosite.tilemath.tile_to_lon(e,a),r=geosite.tilemath.tile_to_lat(t+1,a),n=geosite.tilemath.tile_to_lat(t,a);return[o,r,i,n]},geosite.tilemath.tile_to_lon=function(e,t){return e/Math.pow(2,t)*360-180},geosite.tilemath.tile_to_lat=function(e,t){return n=Math.pi-2*Math.PI*e/Math.pow(2,t),R2D*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))},geosite.http={},geosite.http.build_promises=function(e,t){for(var a=[],i=0;i<t.length;i++){var o=t[i],r={},n=e.get(o,r);a.push(n)}return a},geosite.http.build_features=function(e,t){for(var a=[],i=0;i<e.length;i++){var o=e[i];if(200==o.status){var r=o.data;a=a.concat(geosite.codec.parseFeatures(r,t))}}return a},geosite.layers={},geosite.layers.aggregate_fields=function(e){for(var t=[],a=0;a<e.popup.panes.length;a++)t=t.concat(e.popup.panes[a].fields);return t},geosite.layers.init_baselayers=function(e,t){for(var a={},i=0;i<t.length;i++){var o=t[i];try{a[o.id]=L.tileLayer(o.source.url,{id:o.id,attribution:o.source.attribution})}catch(r){console.log("Could not add baselayer "+i)}}return a},geosite.layers.init_featurelayer_post=function(e,t,a,i,o){void 0!=i?((void 0!=o?o:!0)&&i.addTo(t.map),geosite.api.intend("layerLoaded",{type:"featurelayer",layer:a,visible:o},e)):console.log("Could not add featurelayer "+a+" because it is undefined.")},geosite.layers.init_featurelayer_wms=function(e,t,a,i,o){var r=o.wms,n=L.tileLayer.wms(r.url,{renderOrder:$.inArray(i,a.renderlayers),buffer:r.buffer||0,version:r.version||"1.1.1",layers:r.layers.join(","),styles:r.styles?r.styles.join(","):"",format:r.format,transparent:r.transparent||!1,attribution:o.source.attribution});t.featurelayers[i]=n,geosite.layers.init_featurelayer_post(e,t,i,n,o.visible)},geosite.layers.init_featurelayer_geojson=function(e,t,a,i,o){$.ajax({url:o.source.url,dataType:"json",success:function(a){var r=void 0;if("heatmap"==o.transform){for(var n=[],s=0,l=0;l<a[0].features.length;l++){var u="attribute"in o.heatmap&&""!=o.heatmap.attribute?a[0].features[l].properties[o.heatmap.attribute]:1;n.push([a[0].features[l].geometry.coordinates[1],a[0].features[l].geometry.coordinates[0],u]),u>s&&(s=u)}for(var l=0;l<n.length;l++)n[l][2]=n[l][2]/s;var d=L.heatCanvas();r=L.heatLayer(n,{renderer:d,attribution:o.source.attribution,radius:o.heatmap.radius||25,blur:o.heatmap.blur||15,max:o.heatmap.max||1,minOpacity:o.heatmap.minOpacity||.5})}else r=L.geoJson(a,{attribution:o.source.attribution});t.featurelayers[i]=r,geosite.layers.init_featurelayer_post(e,t,i,r,o.visible)}})},geosite.layers.init_featurelayer=function(e,t,a,i,o){(void 0==t.enabled||1==t.enabled)&&("geojson"==t.type.toLowerCase()?geosite.layers.init_featurelayer_geojson(a,i,o,e,t):"wms"==t.type.toLowerCase()&&geosite.layers.init_featurelayer_wms(a,i,o,e,t))},geosite.layers.init_featurelayers=function(e,t,a,i){$.each(e,function(e,o){geosite.layers.init_featurelayer(e,o,t,a,i)})};