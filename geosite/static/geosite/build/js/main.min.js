var geosite={};geosite.assert_float=function(e,t){return void 0===e||""===e?t:angular.isNumber(e)?e:parseFloat(e)},geosite.assert_array_length=function(e,t,a){return void 0===e||""===e?a:angular.isString(e)?(e=e.split(","),e.length==t?e:a):angular.isArray(e)?e.length==t?e:a:void 0},geosite.intend=function(e,t,a){a.$emit(e,t)},geosite.init_intents=function(e,t){e.on("click",".geosite-intent",function(e){e.preventDefault();var a=$(this);if(a.hasClass("geosite-toggle"))a.hasClass("geosite-off")?(a.removeClass("geosite-off"),geosite.intend(a.data("intent-names")[0],a.data("intent-data"),t)):(a.addClass("geosite-off"),geosite.intend(a.data("intent-names")[1],a.data("intent-data"),t));else if(a.hasClass("geosite-radio")){var i=a.parents(".geosite-radio-group:first").find(".geosite-radio").not(a);a.hasClass("geosite-on")||(a.addClass("geosite-on"),a.data("intent-class-on")&&(a.addClass(a.data("intent-class-on")),i.removeClass(a.data("intent-class-on"))),i.removeClass("geosite-on"),a.data("intent-class-off")&&(a.removeClass(a.data("intent-class-off")),i.addClass(a.data("intent-class-off"))),geosite.intend(a.data("intent-name"),a.data("intent-data"),t))}else geosite.intend(a.data("intent-name"),a.data("intent-data"),t)})},geosite.controller_base=function(e,t){this.intend=geosite.intend,geosite.init_intents($(t),e)},geosite.init_controller_base=function(e){e.controller("GeositeControllerBase",geosite.controller_base)},geosite.init_controller=function(e,t,a){var i=e.data("controllerName");e.data("controllerType");t.controller(i,a||geosite.controller_base)},geosite.init_controllers=function(e,t,a){for(var i=0;i<a.length;i++){var o=a[i];$(o.selector,e).each(function(){try{geosite.init_controller($(this),t,o.controller)}catch(e){console.log('Could not load Geosite Controller "'+o.selector+'"',e)}})}},geosite.init_state=function(e,t){var a=$.extend({},e),i=getHashValueAsFloat(["latitude","lat","y"])||e.lat||0,o=getHashValueAsFloat(["longitude","lon","long","lng","x"])||e.lon||0,n=getHashValueAsInteger(["zoom","z"])||e.z||3,r={lat:i,lon:o,z:n};return a.view=void 0!=a.view?$.extend(a.view,r):r,void 0!=a.filters&&$.each(a.filters,function(e,i){$.each(i,function(i,o){var n=t.filters[e][i].toLowerCase(),r=getHashValue(e+":"+i,n);void 0!=r&&""!=r&&(a.filters[e][i]=r)})}),a},geosite.ui_init_slider_label=function(e,t,a,i){if("ordinal"==t){var o=e.data("label-template").replace(new RegExp("{{(\\s*)value(\\s*)}}","gi"),i);e.data("label").html(o)}else if("continuous"==t)if("true"==a.toLowerCase()){var o=e.data("label-template").replace(new RegExp("{{(\\s*)value(s?).0(\\s*)}}","gi"),i[0]).replace(new RegExp("{{(\\s*)value(s?).1(\\s*)}}","gi"),i[1]);e.data("label").html(o)}else if("min"==a||"max"==a){var o=e.data("label-template").replace(new RegExp("{{(\\s*)value(\\s*)}}","gi"),i);e.data("label").html(o)}},geosite.ui_init_slider_slider=function(e,t,a,i,o,n,r,s){"ordinal"==a?t.slider({range:"true"==i.toLowerCase()?!0:i,value:o,min:0,max:r,step:1,slide:function(a,i){geosite.ui_update_slider_label.apply(this,[a,i]);var o=t.data("output"),n=t.data("options")[i.value],r={};r[o]=n,geosite.intend("filterChanged",{layer:"popatrisk",filter:r},e)}}):"continuous"==a&&("true"==i.toLowerCase()?t.slider({range:!0,values:o,min:n,max:r,step:s,slide:function(a,i){geosite.ui_update_slider_label.apply(this,[a,i]);var o=t.data("output"),n=i.values,r={};r[o]=n,geosite.intend("filterChanged",{layer:"popatrisk",filter:r},e)}}):("min"==i||"max"==i)&&t.slider({range:i,value:o,min:n,max:r,step:s,slide:function(a,i){geosite.ui_update_slider_label.apply(this,[a,i]);var o=t.data("output"),n=i.value/100,r={};r[o]=n,geosite.intend("filterChanged",{layer:"popatrisk",filter:r},e)}}))},geosite.ui_update_slider_label=function(e,t){var a=$(this),i=a.data("type"),o=a.data("range");if("ordinal"==i){var n=a.data("options")[t.value],r=a.data("label-template").replace(new RegExp("{{(\\s*)value(\\s*)}}","gi"),n);a.data("label").html(r)}else if("continuous"==i)if("true"==o.toLowerCase()){var r=a.data("label-template").replace(new RegExp("{{(\\s*)value(s?).0(\\s*)}}","gi"),t.values[0]).replace(new RegExp("{{(\\s*)value(s?).1(\\s*)}}","gi"),t.values[1]);a.data("label").html(r)}else if("min"==o||"max"==o){var r=a.data("label-template").replace(new RegExp("{{(\\s*)value(\\s*)}}","gi"),t.value/100);a.data("label").html(r)}};var getHashValue=function(e,t){var a=void 0;e="string"==typeof e?[e.toLowerCase()]:$.map(e,function(e,t){return e.toLowerCase()});for(var i=location.hash.toLowerCase(),o=0;o<e.length;o++){var n=e[o],r=i.match(new RegExp(n+"=([^&]*)"));if(r&&(a=r[1],void 0!=a&&null!=a&&""!=a))break}if(void 0!=t)if("integer"==t)a=void 0!=a&&null!=a&&""!=a?parseInt(a,10):void 0;else if("integerarray"==t){if(void 0!=a){for(var s=a.split(","),l=[],o=0;o<s.length;o++){var u=s[o];l.push(void 0!=u&&null!=u&&""!=u?parseInt(u,10):void 0)}a=l}}else if("float"==t)a=void 0!=a&&null!=a&&""!=a?parseFloat(a):void 0;else if("floatarray"==t&&void 0!=a){for(var s=a.split(","),l=[],o=0;o<s.length;o++){var u=s[o];l.push(void 0!=u&&null!=u&&""!=u?parseFloat(u):void 0)}a=l}return a},hasHashValue=function(e){var t=getHashValue(e);return void 0!=t&&null!=t&&""!=t},getHashValueAsInteger=function(e){return getHashValue(e,"integer")},getHashValueAsIntegerArray=function(e){return getHashValue(e,"integerarray")},getHashValueAsFloat=function(e){return getHashValue(e,"float")},sortLayers=function(e,t){var a=$.isArray(e)?e:$.map(e,function(e){return e});return a=a.sort(function(e,t){return e.options.renderOrder-t.options.renderOrder}),t===!0&&a.reverse(),a},updateRenderOrder=function(e){for(var t=0;t<e.length;t++)e[t].bringToFront()},layersAsArray=function(e){return $.map(e,function(e,t){return{id:t,layer:e}})};geosite.codec={},geosite.codec.parseFeatures=function(e,t){var a=[];return $(e).find("gml\\:featuremember").each(function(){var e=$(this).children(),i=e.prop("tagName").toLowerCase(),o=geosite.codec.parseAttributes(e,t[i]),n=e.find("geonode\\:shape").find("gml\\:point").find("gml\\:coordinates").text().split(","),r=new L.LatLng(parseFloat(n[1]),parseFloat(n[0])),s={featuretype:i,attributes:o,geometry:r};a.push(s)}),a},geosite.codec.parseAttributes=function(e,t){for(var a={},i=0;i<t.length;i++){var o=t[i],n=o.output||o.attribute;a[n]=void 0;var r=o.attribute||o.input,s=void 0!=r?[r]:o.inputs;if(void 0!=s)for(var l=0;l<s.length;l++){var r=s[l];if(e.find("geonode\\:"+r).length>0){a[n]=e.find("geonode\\:"+r).text();break}}}return a},geosite.popup={},geosite.popup.buildField=function(e,t){var a=e.output||e.attribute,i=void 0,o=!1;if(void 0!=e.when&&"defined"==e.when.toLowerCase()?void 0!=t.attributes[a]&&(o=!0):o=!0,o)if("link"==e.type){var n=void 0!=e.value?e.value:"{{ attributes."+a+" }}";i="<span><b>"+e.label+':</b> <a target="_blank" href="'+e.url+'">',i+=n,i+="</a></span>"}else if("date"==e.type){var n=void 0;if(void 0!=e.value)n=e.value;else{var r=e.format||"medium";n="{{ attributes."+a+" | date:'"+r+"'}}"}i="<span><b>"+e.label+":</b> "+n+"</span>"}else i="<span><b>"+e.label+":</b> {{ attributes."+a+" }}</span>";return i},geosite.popup.openPopup=function(e,t,a,i,o){for(var n=t,r=n.popup.panes,s=[],l=0;l<r.length;l++){for(var u=r[l],d=[],g=0;g<u.fields.length;g++){var f=geosite.popup.buildField(u.fields[g],a);void 0!=f&&d.push(f)}var p=d.join("<br>");s.push(p)}var v=void 0;if(r.length>1){var c=[],u=r[0];c.push('<li class="active"><a data-toggle="tab" href="#'+u.id+'">'+u.tab.label+"</a></li>");for(var l=1;l<r.length;l++)u=r[l],c.push('<li><a data-toggle="tab" href="#'+u.id+'">'+u.tab.label+"</a></li>");var h='<ul class="nav nav-tabs nav-justified">'+c.join("")+"</ul>",b=[];b.push('<div id="'+r[0].id+'" class="tab-pane fade in active">'+s[0]+"</div>");for(var l=1;l<r.length;l++)b.push('<div id="'+r[l].id+'" class="tab-pane fade">'+s[l]+"</div>");var _='<div class="tab-content">'+b.join("")+"</div>";v=h+_}else v=s[0];var m=e(v)(a),y=new L.Popup({maxWidth:n.popup.maxWidth||400},void 0);y.setLatLng(new L.LatLng(i.lat,i.lon)),y.setContent(m),o.openPopup(y)},geosite.tilemath={D2R:Math.PI/180,R2D:180/Math.PI},geosite.tilemath.point_to_bbox=function(e,t,a,i){var o=geosite.tilemath.point_to_radius(a),n=e+o;void 0!=i&&i>=0&&(n=n.toFixed(i));var r=e-o;void 0!=i&&i>=0&&(r=r.toFixed(i));var s=t-o;void 0!=i&&i>=0&&(s=s.toFixed(i));var l=t+o;return void 0!=i&&i>=0&&(l=l.toFixed(i)),[r,s,n,l]},geosite.tilemath.point_to_radius=function(e){return 4/e},geosite.tilemath.tms_to_bbox=function(e,t,a){var i=geosite.tilemath.tile_to_lon(e+1,a),o=geosite.tilemath.tile_to_lon(e,a),n=geosite.tilemath.tile_to_lat(t+1,a),r=geosite.tilemath.tile_to_lat(t,a);return[o,n,i,r]},geosite.tilemath.tile_to_lon=function(e,t){return e/Math.pow(2,t)*360-180},geosite.tilemath.tile_to_lat=function(e,t){return n=Math.pi-2*Math.PI*e/Math.pow(2,t),R2D*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))},geosite.http={},geosite.http.build_promises=function(e,t){for(var a=[],i=0;i<t.length;i++){var o=t[i],n={},r=e.get(o,n);a.push(r)}return a},geosite.http.build_features=function(e,t){for(var a=[],i=0;i<e.length;i++){var o=e[i];if(200==o.status){var n=o.data;a=a.concat(geosite.codec.parseFeatures(n,t))}}return a},geosite.layers={},geosite.layers.aggregate_fields=function(e){for(var t=[],a=0;a<e.popup.panes.length;a++)t=t.concat(e.popup.panes[a].fields);return t},geosite.layers.init_baselayers=function(e,t){for(var a={},i=0;i<t.length;i++){var o=t[i];try{a[o.id]=L.tileLayer(o.source.url,{id:o.id,attribution:o.source.attribution})}catch(n){console.log("Could not add baselayer "+i)}}return a},geosite.layers.init_featurelayer_post=function(e,t,a,i){void 0!=i?(i.addTo(t.map),geosite.intend("layerLoaded",{type:"featurelayer",layer:a},e)):console.log("Could not add featurelayer "+a+" because it is undefined.")},geosite.layers.init_featurelayer_wms=function(e,t,a,i,o){var n=o.wms,r=L.tileLayer.wms(n.url,{renderOrder:$.inArray(i,a.renderlayers),buffer:n.buffer||0,version:n.version||"1.1.1",layers:n.layers.join(","),styles:n.styles?n.styles.join(","):"",format:n.format,transparent:n.transparent||!1,attribution:o.source.attribution});t.featurelayers[i]=r,geosite.layers.init_featurelayer_post(e,t,i,r)},geosite.layers.init_featurelayer_geojson=function(e,t,a,i,o){$.ajax({url:o.source.url,dataType:"json",success:function(a){var n=L.geoJson(a,{attribution:o.source.attribution});t.featurelayers[i]=n,geosite.layers.init_featurelayer_post(e,t,i,n)}})},geosite.layers.init_featurelayer=function(e,t,a,i,o){(void 0==t.enabled||1==t.enabled)&&("geojson"==t.type.toLowerCase()?geosite.layers.init_featurelayer_geojson(a,i,o,e,t):"wms"==t.type.toLowerCase()&&geosite.layers.init_featurelayer_wms(a,i,o,e,t))},geosite.layers.init_featurelayers=function(e,t,a,i){$.each(e,function(e,o){geosite.layers.init_featurelayer(e,o,t,a,i)})};